/**
 * @license
 *
 * Copyright (c) 2015, University of Washington Interactive Data Lab.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 *
 * * Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 * * Neither the name of the University of Washington Interactive Data Lab
 *   nor the names of its contributors may be used to endorse or promote products
 *   derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
"use strict";angular.module("voyager",["vlui","zeroclipboard","720kb.tooltips","LocalStorageModule","ngOrderObjectBy","Chronicle","ngTouch","ngSanitize"]).constant("_",window._).constant("jQuery",window.$).constant("vl",window.vl).constant("vg",window.vg).constant("cp",window.cp).constant("tv4",window.tv4).constant("Blob",window.Blob).constant("URL",window.URL).constant("Tether",window.Tether).constant("Drop",window.Drop).constant("dl",window.dl).config(["uiZeroclipConfigProvider",function(e){e.setZcConf({swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"})}]).config(["consts",function(e){window.vl.extend(e,{debug:!0,debugInList:!0,numInitClusters:15,numMoreClusters:9,appId:"voyager",enableExclude:!0})}]),angular.module("voyager").directive("visList",["Fields","Visrec","vl","jQuery","consts","_","Logger",function(e,t,i,s,l,n,a){return{templateUrl:"components/vislist/vislist.html",restrict:"E",replace:!0,scope:{},link:function(o,d){function c(){o.limit=l.numInitClusters,d.scrollTop(0);var i=e.update();t.update.projections(i)}o.Fields=e,o.Visrec=t,o.consts=l,o.shorthands=i.field.shorthands,o.limit=l.numInitClusters,d.bind("scroll",function(){s(this).scrollTop()+s(this).innerHeight()>=s(this)[0].scrollHeight&&o.limit<t.fieldSets.length&&o.increaseLimit()}),o.increaseLimit=function(){o.limit+l.numMoreClusters>t.numClustersGenerated&&t.update.clusters(o.limit+l.numMoreClusters),o.limit+=l.numMoreClusters,a.logInteraction(a.actions.LOAD_MORE,o.limit)},o.select=function(e,i){a.logInteraction(a.actions.DRILL_DOWN_OPEN,e.key),t.selectedFieldSet=e,t.selectedCluster=i},o.isInList=function(e){return e in t.chartClusters};var r=n.debounce(c,200,{maxWait:1500});o.$watch("Fields.fields",function(e,t){t&&0!==n.keys(t).length?r():c()},!0)}}}]),angular.module("voyager").directive("functionList",["_","vl","Logger",function(e,t,i){return{templateUrl:"components/functionlist/functionlist.html",restrict:"E",scope:{field:"="},link:function(e){function s(e){return"T"===e?t.schema.timeUnits:[]}function l(e){return t.schema.aggregate.supportedEnums[e]}var n="bin",a="raw",o="count",d="AUTO";e.func={selected:d,list:[d]},e.functionChanged=function(t){var o=e.field,c=o?o.type:"";o&&(o._bin=t===n||void 0,o._aggregate=-1!==l(c).indexOf(t)?t:void 0,o._timeUnit=-1!==s(c).indexOf(t)?t:void 0,o._raw=t===a||void 0,o._any=t===d||void 0,i.logInteraction(i.actions.FUNC_CHANGE,t))},e.$watch("field",function(i){if(i){var c=i.name?i.type:"";if(t.field.isCount(i))e.func.list=[o],e.func.selected=o;else{var r="O"===c;e.func.list=(r?[a]:[d,a]).concat(s(c)).concat(l(c).filter(function(e){return e!==o})).concat("Q"===c?[n]:[]),e.func.selected=i._bin?n:i._raw?a:i._aggregate||i._timeUnit||(r?a:d)}}},!0)}}}]),angular.module("voyager").directive("fieldListItem",["Dataset","Fields","consts",function(e,t,i){return{templateUrl:"components/fieldlistitem/fieldlistitem.html",restrict:"E",replace:!0,scope:{field:"="},link:function(e,s){e.consts=i,e.Fields=t,e.popupContent=s.find(".popup-functions")[0]},controller:["$scope","Dataset",function(e,t){e.stats=t.stats[e.field.name]}]}}]),angular.module("voyager").directive("fieldList",["Dataset","Fields",function(e,t){return{templateUrl:"components/fieldlist/fieldlist.html",restrict:"E",scope:{},link:function(i){i.Dataset=e,i.Fields=t}}}]),angular.module("voyager").directive("encodingVariations",["Visrec","Bookmarks","consts","$document","_","Logger",function(e,t,i,s,l,n){return{templateUrl:"components/encodingvariations/encodingvariations.html",restrict:"E",replace:!0,scope:{},link:function(a){function o(e){27===e.keyCode&&(console.log("escape"),a.close(),angular.element(s).off("keydown",o))}a.Visrec=e,a.Bookmarks=t,a.consts=i,a._=l,angular.element(s).on("keydown",o),a.isInList=function(t){return e.selectedCluster&&t===e.selectedCluster.key},a.select=function(e){a.selectedSubcluster=e,n.logInteraction(n.actions.CLUSTER_SELECT,e)},a.close=function(){n.logInteraction(n.actions.DRILL_DOWN_CLOSE,e.selectedCluster.key),a.Visrec.selectedCluster=null},a.$watch("Visrec.selectedCluster",function(e){a.selectedSubcluster=e?e[0]:null})}}}]),angular.module("voyager").service("Visrec",["cp","vl","_","consts","Config","Dataset","Logger","Fields",function(e,t,i,s,l,n,a,o){function d(i){var s=e.gen.encodings([],i,n.stats,{data:l.getData(),config:l.getConfig()}),a=e.cluster(s).map(function(e){return e.map(function(e){var s=t.Encoding.fromSpec(e,{});return{fieldSetKey:i.key,fieldSet:i,vlSpec:e,encoding:s,shorthand:s.toShorthand(),score:e.score,scoreFeatures:e.scoreFeatures}})});return a.key=i.key,a}var c={projections:[],aggregates:{},fieldSetDict:{},fieldSets:[],fieldSetKeys:[],chartClusters:{},numClustersGenerated:0,selectedCluster:null,selectedFieldSet:null,update:{}},r={genTypeCasting:!1},u={genTypeCasting:!1,maxCardinalityForAutoAddOrdinal:null,omitDotPlot:!0},g={genTypeCasting:!1};return c.update.projections=function(i){var l=(new Date).getTime(),a=e.gen.projections(i,n.stats,{}||(0===o.selected.length?u:g)),f={},h={},p=[],m={},v=(new Date).getTime();a.forEach(function(t){var i=t.key,s=i===o.selectedPKey,l=s?r:0===o.selected.length?u:g;f[i]=e.gen.aggregates([],t,n.stats,l),f[i].forEach(function(e){h[e.key]=e,e.isExactMatch=s,p.push(e)})});var w=(new Date).getTime();c.numClustersGenerated=Math.min(s.numInitClusters,p.length);for(var k=0;k<c.numClustersGenerated;k++){var b=p[k];m[b.key]=d(b)}c.projections=a,c.aggregates=f,c.fieldSetDict=h,c.fieldSets=p,c.chartClusters=m;var y=(new Date).getTime(),C=i.filter(function(e){return e.selected});console.log("gen time â€“ projections ",t.field.shorthands(C)," :",v-l,"aggregates:",w-v,"encodings:"+(y-w),"total:",y-l)},c.update.clusters=function(e){if(e>c.numClustersGenerated){var t=c.fieldSets,i=c.numClustersGenerated,s=c.chartClusters;e=Math.min(e,t.length);for(var l=i;e>l;l++){var n=t[l];s[n.key]=d(n)}c.numClustersGenerated=e}},c}]),angular.module("voyager").controller("MainCtrl",["$scope","$document","Chronicle","Visrec","Config","Dataset","Fields","Bookmarks","Logger","Drop","consts",function(e,t,i,s,l,n,a,o,d,c,r){l.config.useRawDomain=!0,e.consts=r,e.canUndo=!1,e.canRedo=!1,e.embedded=!!r.embeddedData,e.Visrec=s,e.Fields=a,e.Dataset=n,e.Config=l,e.Bookmarks=o,e.showBookmark=!1,e.hideBookmark=function(){e.showBookmark=!1},o.load(),e.embedded&&(n.dataset={values:r.embeddedData}),n.dataset={name:"Population",url:"data/population.json",id:"population",group:"sample"},n.datasets=[{name:"Population",url:"data/population.json",id:"population",group:"sample"}],console.log(">>>> Dataset",n),n.update(n.dataset).then(function(){l.updateDataset(n.dataset),a.updateSchema(n.dataschema),e.chron=i.record("Fields.fields",e,!0,["Visrec.numClustersGenerated","Dataset.dataset","Dataset.dataschema","Dataset.stats","Config.config"]),e.canUndoRedo=function(){e.canUndo=e.chron.canUndo(),e.canRedo=e.chron.canRedo()},e.chron.addOnAdjustFunction(e.canUndoRedo),e.chron.addOnUndoFunction(e.canUndoRedo),e.chron.addOnRedoFunction(e.canUndoRedo),e.chron.addOnUndoFunction(function(){d.logInteraction(d.actions.UNDO)}),e.chron.addOnRedoFunction(function(){d.logInteraction(d.actions.REDO)}),angular.element(t).on("keydown",function(t){return t.keyCode!=="Z".charCodeAt(0)||!t.ctrlKey&&!t.metaKey||t.shiftKey?t.keyCode==="Y".charCodeAt(0)&&(t.ctrlKey||t.metaKey)?(e.chron.redo(),e.$digest(),!1):t.keyCode==="Z".charCodeAt(0)&&(t.ctrlKey||t.metaKey)&&t.shiftKey?(e.chron.redo(),e.$digest(),!1):void 0:(e.chron.undo(),e.$digest(),!1)})})}]),angular.module("voyager").factory("Fields",["_","Dataset","vl","cp","Logger",function(e,t,i,s,l){function n(e){e.selected=void 0,e._any=!i.field.isTypes(e,["O","N"])&&"count"!==e.aggregate,delete e._raw,delete e._aggregate,delete e._timeUnit}var a={fields:{},highlighted:{},selected:[],selectedKey:null};return a.updateSchema=function(i){i=i||t.dataschema,a.fields=e(i).reduce(function(e,t){return n(t),e[t.name]=t,e},{}),a.highlighted={}},a.update=function(){var e=a.getList();return a.selected=e.filter(function(e){return e.selected}),a.selectedPKey=s.gen.projections.key(a.selected),l.logInteraction(l.actions.FIELDS_CHANGE,{selected:a.selected,list:e}),e},a.reset=function(){e.each(a.fields,n)},a.getList=function(){var i=e.sortBy(e.values(a.fields),function(e){return t.fieldOrderBy.typeThenName(e)});return i},a.setSelected=function(e,t){(a.fields[e]||{}).selected=t},a.toggleSelected=function(e){var t=a.fields[e]||{};t.selected=t.selected?void 0:!0},a.isSelected=function(e){return(a.fields[e]||{}).selected},a.setHighlight=function(e,t){a.highlighted[e]=t},t.onUpdate.push(a.updateSchema),a}]),angular.module("voyager").run(["$templateCache",function(e){e.put("app/main/main.html",'<div ng-controller="MainCtrl"><div class="flex-root vflex full-width full-height"><div class="full-width no-shrink"><div class="card no-right-margin no-top-margin margin-bottom"><div class="right flex-root hflex"><div class="controls"><span ng-show="consts.debug"><a ng-href="{{ {fields: Fields.fields} | reportUrl }}" target="_blank" class="command debug" tooltips="" tooltip-size="small" tooltip-content="Report an issue"><i class="fa fa-bug"></i></a><a class="command debug" ng-click="showDevPanel = !showDevPanel" tooltips="" tooltip-size="small" tooltip-content="Debug Tool"><i class="fa fa-wrench"></i></a></span> <a class="command" ng-click="showBookmark=true"><i class="fa fa-bookmark"></i> Bookmarks ({{Bookmarks.length}})</a> <a class="command" ng-click="chron.undo()" ng-class="{disabled: !canUndo}"><i class="fa fa-undo"></i> Undo</a> <a class="command" ng-click="chron.redo()" ng-class="{disabled: !canRedo}"><i class="fa fa-repeat"></i> Redo</a></div><div><a href="https://idl.cs.washington.edu/" target="_blank" class="logo"></a></div></div><h1><img src="assets/images/jiff_logo.png" class="jiff-logo"> Population Data <i class="fa fa-chevron-right" style="font-size: 0.75em; color: #999;"></i> Explorer</h1></div><alert-messages></alert-messages></div><div class="hflex full-width main-panel grow-1"><div class="pane data-pane noselect"><div class="card abs-100 no-top-margin"><div class="right"><dataset-selector ng-if="!embedded"></dataset-selector></div><h2>Data</h2><field-list></field-list></div></div><div class="pane vis-list-pane"><vis-list></vis-list></div></div><div class="hflex full-width dev-panel" ng-show="showDevPanel"><div class="pane"><label><input type="checkbox" ng-model="consts.debugInList"> Show Debug In List</label></div></div></div><bookmark-list active="showBookmark" deactivate="hideBookmark();" highlighted="Fields.highlighted"></bookmark-list></div>'),e.put("components/encodingvariations/encodingvariations.html",'<div class="encoding-variations modal" ng-show="Visrec.selectedCluster"><div class="wrapper"><div class="vflex full-width full-height" id="evs" ng-if="Visrec.selectedCluster"><div class="encoding-variations-header modal-header no-shrink card no-top-margin no-right-margin margin-bottom"><div class="right"><a ng-click="close()" class="right">Close</a></div><div class="field-set-info no-bottom-margin"><b>Various Visualizations Showing</b><field-info ng-repeat="field in Visrec.selectedFieldSet" field="field" show-type="true" class="selected"></field-info><span ng-if="consts.debug" tooltips="" tooltip-size="small" tooltip-content="{{_.pluck(selectedSubcluster, \'shorthand\').join(\'<br/>\')}}"></span></div></div><div class="hflex flex-grow-1 encoding-variations-main"><div class="selected-variation no-shrink"><vl-plot-group chart="selectedSubcluster[0]" disabled="!Visrec.selectedCluster" config-set="large" show-bookmark="true" show-debug="consts.debug && consts.debugInList" show-filter-null="true" show-log="true" show-mark-type="true" show-sort="true" show-transpose="true" always-scrollable="true" tooltip="true" priority="consts.priority.popup" class="abs-100 scroll-xy full-vl-plot-group no-top-margin"></vl-plot-group></div><div class="variations vflex flex-grow-1 scroll-y" ng-if="Visrec.selectedCluster.length > 1"><div class="full-width"><vl-plot-group ng-repeat="subcluster in Visrec.selectedCluster" ng-class="{selected: selectedSubcluster == subcluster}" chart="subcluster[0]" disabled="!subcluster || !subcluster[0]" is-in-list="isInList" show-bookmark="true" rescale="true" thumbnail="true" max-width="300" ng-click="select(subcluster)" class="row-vl-plot-group clickable" priority="consts.priority.popup + $index + 1"></vl-plot-group></div></div></div></div></div></div>'),e.put("components/fieldlist/fieldlist.html",'<div class="schema"><div class="field" ng-repeat="field in Dataset.dataschema | orderBy: Dataset.fieldOrder"><field-list-item field="field"></field-list-item></div><div class="tool"><a ng-click="Fields.reset()"><i class="fa fa-eraser"></i> Reset</a></div></div>'),e.put("components/fieldlistitem/fieldlistitem.html",'<div class="field-list-item full-width" ng-mouseover="Fields.highlighted[field.name] = true" ng-mouseout="Fields.highlighted[field.name] = false"><i class="fa selection clickable" ng-class="{\'fa-check-square\': Fields.isSelected(field.name), \'fa-square\': Fields.isSelected(field.name) === undefined, \'fa-minus-circle\': Fields.isSelected(field.name) === false}" ng-click="Fields.toggleSelected(field.name)" ng-dblclick="consts.enableExclude && Fields.setSelected(field.name, false)"></i><field-info field="field" show-type="true" show-caret="true" disable-count-caret="true" show-info="true" popup-content="popupContent" action="Fields.toggleSelected(field.name)" class="flex-grow-1 list-item clickable" ng-class="{selected: Fields.isSelected(field.name), excluded: Fields.isSelected(field.name)===false, highlighted: Fields.highlighted[field.name]}"></field-info><div class="drop-container"><div class="popup-menu popup-functions" ng-show="(field.type!==\'O\' && field.aggregate!==\'count\') || consts.enableExclude"><div style="width:150px"><function-list field="Fields.fields[field.name]"></function-list></div><div class="inclusion" ng-show="consts.enableExclude"><h4>Field</h4><div><a ng-class="{inactive: Fields.isSelected(field.name) !== true}" ng-click="Fields.setSelected(field.name, true)"><i class="fa fa-check-square"></i> Include</a></div><div><a ng-class="{inactive: Fields.isSelected(field.name) !== undefined}" ng-click="Fields.setSelected(field.name, undefined)"><i class="fa fa-square"></i> Optional</a></div><div><a ng-class="{inactive: Fields.isSelected(field.name) !== false}" ng-click="Fields.setSelected(field.name, false)"><i class="fa fa-minus-circle"></i> Exclude</a></div></div></div></div></div>'),e.put("components/functionlist/functionlist.html",'<div class="mb5" ng-if="func.list.length > 1"><h4>Functions</h4><label class="func-label field-func" ng-repeat="f in func.list"><input type="radio" ng-value="f" ng-model="func.selected" ng-change="functionChanged(f)"> {{f === \'avg\' ? \'mean\' : f || \'-\'}}</label></div>'),e.put("components/vislist/vislist.html",'<div id="vislist" class="abs-100 scroll-y"><div class="exact-match-list" ng-if="Fields.selected.length > 0 && Visrec.aggregates[Fields.selectedPKey].length > 0"><div class="card no-top-margin vis-list-header"><span class="desc">Showing Data Variations for</span><field-info ng-repeat="(name, field) in Fields.selected" field="field" show-type="true" ng-class="{ selected: true, highlighted: (Fields.highlighted||{})[field.name] }" ng-mouseover="(Fields.highlighted||{})[field.name] = true" ng-mouseout="(Fields.highlighted||{})[field.name] = false"></field-info></div><div class="vis-list hflex flex-wrap"><vl-plot-group ng-repeat="fieldSet in Visrec.aggregates[Fields.selectedPKey]" ng-init="cluster = Visrec.chartClusters[fieldSet.key]" class="wrapped-vl-plot-group" chart="cluster[0][0]" is-in-list="isInList" field-set="fieldSet" show-bookmark="true" show-debug="consts.debug && consts.debugInList" show-expand="true" show-filter-null="true" show-sort="true" overflow="true" tooltip="true" is-selected="Fields.isSelected" highlighted="Fields.highlighted" expand-action="select(fieldSet, cluster, $index)" priority="consts.priority.vislist + $index"></vl-plot-group></div></div><div ng-if="Fields.selected.length === 0" class="card vis-list-header no-top-margin"><span class="desc">Start by looking at some univariate distributions below or select some fields with the data selector!</span></div><div ng-if="Fields.selected.length > 0" class="card vis-list-header"><span class="desc">Showing Data Variations for</span><field-info ng-repeat="(name, field) in Fields.selected" field="field" show-type="true" ng-class="{ selected: true, highlighted: (Fields.highlighted||{})[field.name] }" ng-mouseover="(Fields.highlighted||{})[field.name] = true" ng-mouseout="(Fields.highlighted||{})[field.name] = false"></field-info><span class="desc">with one additional field.</span></div><div class="vis-list hflex flex-wrap"><vl-plot-group ng-repeat="fieldSet in Visrec.fieldSets | limitTo: limit - Visrec.aggregates[Fields.selectedPKey].length" ng-init="cluster = Visrec.chartClusters[fieldSet.key]" ng-if="!fieldSet.isExactMatch" class="wrapped-vl-plot-group" chart="cluster[0][0]" is-in-list="isInList" field-set="fieldSet" is-selected="Fields.isSelected" highlighted="Fields.highlighted" show-bookmark="true" show-debug="consts.debug && consts.debugInList" show-expand="true" show-filter-null="true" show-sort="true" overflow="true" tooltip="true" expand-action="select(fieldSet, cluster, $index)"></vl-plot-group></div><encoding-variations ng-show="Visrec.selectedCluster"></encoding-variations><a ng-click="increaseLimit()"><div class="vis-list-more" ng-show="limit < Visrec.fieldSets.length">Load more...</div></a></div>')}]);